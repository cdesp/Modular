ORG $C000
		JP START

INCLUDE MYOS_2_0000_HARD.SYM

		CH376_ERROR EQU RS_MESG


INCLUDE ATL_SERIAL.Z80
INCLUDE ATL_CH376S.Z80
INCLUDE ATL_STORAGE_NEW.Z80
INCLUDE ATL_UTILS.Z80
		

;STORAGE DEVICE INIT (NEW USB DEVICE)
START:		DI
		CALL RS_MESG
		DEFM "TESTING"
		DB 10,13,0
		CALL STRG_INIT
		JR Z, STINIOK
		CALL RS_MESG
		DEFM "ERROR INITILIZING CH376S"
		DB 10,13,0
		HALT
STINIOK:	CALL RS_MESG
		DEFM "STORAGE DEVICE OK"
		DB 10,13,0
		LD A,6				;USB DRIVE
		CALL STRG_OPENCRD		;MOUNT THE DRIVE
		JR Z, STOPNOK
		CALL OS_RSMSG
		DEFM "ERROR MOUNTING THE DRIVE"
		DB 10,13,0
		HALT
STOPNOK:	CALL STRG_PRDRVINFO		;PRINT DRIVE INFO

		LD B,5
		LD A,9			;PAGE 9 TO BANK 5
		CALL PUTTOBANK
		LD HL, BLFILE		
		LD BC, 8000		;MAX FILE SIZE
		LD DE, $A000
		CALL STRG_LOADFILE
		JR NC, CHFILOK
		CALL OS_RSMSG
		DEFM "ERROR LOADING BOOTLOADER"
		DB 13,10,0
		HALT
CHFILOK:	CALL OS_RSMSG
		DEFM "BOOTLOADER LOADED OK"
		DB 13,10
		DEFM "EXECUTING BOOTLOADER........."
		DB 13,10
		DB 13,10
		DB 13,10,0
		LD B,0
		LD A,9			;PAGE 9 TO BANK 5
		CALL PUTTOBANK
		JP 0			;START BOOTLOADER


PUTTOBANK:	PUSH BC
		LD C,DEVMMU
				;LD B,B.SHL.5
		SLA B
		SLA B
		SLA B
		SLA B
		SLA B								
		OUT (C),A
		POP BC
		RET

OS_PRINTMSG:
OS_RSMSG:
;PRINTS A ZT MESSAGE FOLLOWING THIS CALL
;DESTROYS A AND ALTERNATIVE REGISTERS		
		EXX		
		POP HL
		CALL RS_TXT
		PUSH HL
		EXX
		RET	



BLFILE:		DEFM "\BOOTLD.BIN"
		DB 0

	;SERIAL
	@SERERR 	DEFS 1							;
	;STORAGE
	@USBBUF		DEFS 50							;CH376 USB BUFFER
	@STRGBUFF 	DEFS 40 						;USED FOR DIRECTORY AND FILENAME
	@LINESTR:	DEFS 2		;ADDRESS OF LINEBUF FOR PRINTING ON STRING
	@LINEPOS	DEFS 1
	@NUMBUF		DEFS 7
	@STRG_STAT	DEFS 1
