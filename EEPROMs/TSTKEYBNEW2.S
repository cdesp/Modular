ORG $4000

INCLUDE MYOS_2_0000_HARD.SYM

PS2KB_PUSH EQU 0X0B48

DOAGN:		LD HL,MESG
		CALL RS_TXT
		LD A,2
		OUT (DEVKBI), A 						;CLEAR 393 COUNTER
		CALL DOZERO		
CHKAGN:		EI
		LD A,(INT2TE)
		CP 1
		CALL Z,DOGETKEY
		CALL RS_KEYRD
		JR Z, CHKAGN
		CALL RS_RX
		CP 'M'
		JP Z, 4
		CP 'S'
		CALL Z,DOSHOW
		CP 'C'
		CALL Z,DOCLR
		CP 'Z'
		CALL Z,DOGETKEY		
		JR DOAGN

KG		DB 0

DOCLR:		CALL DOZERO
		LD HL,KBDQIDX2
		XOR A
		LD (HL),A
		LD HL,KG
		LD (HL),A
		RET

DELAY:		LD B,30
AGME:		DJNZ AGME
		RET


DOGETKEY:	DI
		LD A,2
		OUT (DEVKBI), A 						;CLEAR 393 COUNTER
		CALL MYGETKEY
		;OR A
		;JR Z,DOOUT
		;SHOW KB KEY
		LD HL,HXN
		CALL StrfHex
		LD HL,HXN
		CALL RS_TXT

		;CALL PS2KB_PUSH
		LD HL,KG
		INC (HL)
DOOUT:		XOR A
		EI
		RET
		
;SIGNALS READY FOR NEXT CHAR
DOZERO:		;LD A,2
		;OUT (DEVKBI), A 						;CLEAR 393 COUNTER
		XOR A
		OUT (DEVKBI), A 						;CLEAR 7474 FFLOP
		;LD A,2
		OUT (DEVKBI), A 						;CLEAR 393
		EI								;CLEAR INTERRUPT
		CALL DELAY
		DI
		LD HL,INT2TE		
		LD (HL),A		
		RET

MYGETKEY:	IN A,(DEVKBI)		
KEYOK:		CALL REVBITS                                                    ;remove this when hardware fixed
		LD C, A		
		CALL DOZERO			
		LD A, C		
		RET

MESG	DEFM "S:SHOW C:CLEAR M:MENU"
	DB 13,10,0

HXN	DEFM "00"
	DB 13,10,0

;TEMPORARY ON NEW BOARD DATA WILL COME AS SUPPOSED
REVBITS:	ld b, 8
		ld l, a
REVLOOP:	
		rl l
		rra
		djnz REVLOOP
		RET
		
DOSHOW:		LD HL,KG
		LD A,(HL)
		LD HL,HXN
		CALL StrfHex
		LD HL,HXN
		CALL RS_TXT
		LD HL,KBDQIDX2
		LD A,(HL)
		OR A
		RET Z
		LD B,A
DSAGN:		INC HL
		LD A,(HL)
		PUSH BC
		PUSH HL
		LD HL,HXN
		CALL StrfHex
		LD HL,HXN
		CALL RS_TXT
		POP HL
		POP BC
		DJNZ DSAGN		
		RET		
