ORG $9000

JP AGN

INCLUDE MYOS_2_0000.SYM
INCLUDE ATL_PS2KEYB.Z80
DELAYMILI EQU $226A


AGN:    LD HL,MS3
    CALL RS_TXT
 CALL GET_CHAR	;TAKE A CHAR FROM RS232 OR PS2 KEYB
CP 'M'
JP Z,MENU

CP 'T'
CALL Z,TEST2
CP 'R'
CALL Z,READCH
CP 'Y'
CALL Z,TEST1
JR AGN

MS3 DEFM 'T:TEST; M:MENU '
    DEFB 10,13,0



TEST1:  CALL PS2KEY
        CP 0
	JR Z,TEST1
	CALL PS2KEY
	CALL PS2KEY
	
	CALL SOUTAS

	RET


TEST2: 	LD B,10
NXT:	PUSH BC

NOKEY:	CALL GTKEY1
	OR A
	JR Z,NOKEY
	CALL SOUTAS

	POP BC
	DJNZ NXT
	RET

        


READCH:
       CALL GTKEY
       LD D,A
       PUSH DE
       CALL PS2LOK
       CP 0
       POP DE 
       JR Z,READCH

       RET


@GTKEY1:	
		CALL PS2KEY							;GET A KEY FROM PS2
		RET Z
		PUSH AF
		CALL SOUTAS		
		POP AF
		;CALL DEL2
		CP $E1 								;BREAK KEY
		CALL Z, GTBRK
		CP $F0 								;240 KEY RELEASED
		CALL Z, GTREL1
		CP $E0 								;224 EXTENDED KEYS
		CALL Z, GTEXT
		
		
		CP 18 								;LEFT SHIFT
		CALL Z, SHFTOG
		CP 89 								;RIGHT SHIFT
		CALL Z, SHFTOG
		CP 20 								;RIGHT CONTROL
		CALL Z, CTRTOG
		CP 17 								;LEFT ALT
		CALL Z, ALTTOG
		CP $58 								;CAPS LOCK
		CALL Z, CAPSTOG
;	CP 0
;	JR Z,GTKEY ;INVALID KEY (RELEASED,ETC)
		RET


GTREL1:		
		
		CALL PS2KEY
		OR A
		JR Z,GTREL1
		;RET Z
INC A
		CALL SOUTAS							; THIS IS THE RELEASED KEY
DEC A
		
		CP 18 								; LSHIFT RELEASED
		CALL Z, SHFRES							; RESET SHIFT
		CP 20 								; LCTRL RELEASED
		CALL Z, CTRRES							; RESET CONTROL
		CP 17 								; LALT RELEASED
		CALL Z, ALTRES							; RESET ALT
		CP 89 								; RSHIFT RELEASED
		CALL Z, SHFRES							; RESET SHIFT
		XOR A 								; NO KEY
		RET




