ORG $9000
	
DEVSTOR EQU $30



MENU EQU $0004
LCD_PRINTCHAR EQU $100D
LCD_MSG EQU $1212
GET_CHAR EQU $031D
RS_TXT EQU $060D





     	LD A,3 ;12  ;9600BPS FOR ARDUINO INTERFACE
     	CALL STOR_INI

LP1:    LD HL,MSG1
	CALL RS_TXT
	CALL GET_CHAR 
	CP 'A'
	CALL Z,APRESS
	CP 'O'
	CALL Z,OPENCRD
	CP 'D'
	CALL Z,DIRLIST
	CP 'C'
	CALL Z,DIRCHG
	CP 'M'
	JP Z,MENU
        JR LP1

MSG1	DEFM "O:OPENCARD D:DIRLIST | M:MENU"
	DB 10,13,0

SENDCMD:LD B,4 
NXTBT:	LD A,(HL)
	CALL STOR_TX
	DJNZ NXTBT
	RET

OPENCRD:LD HL,CMDOPN
	CALL SENDCMD
	CALL DEL2
	CALL STOR_RX   ;GET RESULT	
	RET

DIRLIST:LD HL,CMDDIR
	CALL SENDCMD
	CALL DEL2
	;WE RECEIVE THE DIR LIST UNTIL 255
	LD DE,BUFFER
NXTCHR	CALL STOR_RX 
	CP 255
	JR Z,DIROUT
	;PRINT TO LCD
	CALL LCD_PRINTCHAR
	JR NXTCHR
DIROUT:	CALL DEL2
	CALL STOR_RX   ;GET RESULT	
	RET


DIRCHG: LD HL,CMDCHD
	CALL SENDCMD
	LD HL,DIRCRY
CNXCHR:	LD A,(HL)
	CP 0
	JR Z,DCHOUT
	CALL STOR_TX
	INC HL
	JR CNXCHR
DCHOUT:	CALL DEL2
	CALL STOR_RX   ;GET RESULT	
	RET



CMDOPN  DB 1,0,0,0
CMDDIR  DB 10,0,0,0
CMDCHD  DB 10,0,0,0


DIRCRY	DEFM "Test"
	DB 13,0

BUFFER  DEFS 50


APRESS: CALL DEL2
	LD HL,MES1
	CALL STOR_TXT
	LD HL,MES2
	CALL STOR_TXT
	RET

MES1    DEFM "1234567890"
	DB 10,13,0

MES2    DEFM "ABCDEFGHIJKLMNOPQRSTUVWXYZ "
	DB 10,13,0


;THIS DELAYS 1MILISECOND ON 8MHZ CPU
DELAY:
DELAYMILISEC:	PUSH AF
	PUSH DE
	LD DE,300	;2000 1 MILISEC =300 ON 8MHZ SO 30= 0.1 MILISECS = 100 MICROSECS
DEL1:	DEC DE
	LD A,D            ;TEST FOR DE=00
	OR E
	JR NZ,DEL1 	
	POP DE
	POP AF
	RET

DEL2:LD B,80
DELAYMILI:	
S1:	CALL DELAYMILISEC
	DJNZ S1	
	RET


INCLUDE ATL_STORAGE.Z80