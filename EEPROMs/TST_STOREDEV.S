ORG $9000
	
DEVSTOR EQU $30



MENU EQU $0004
LCD_PRINTCHAR EQU $100D
LCD_MSG EQU $1212
GET_CHAR EQU $031D
RS_TXT EQU $060D
RS_TX EQU $05FE





     	LD A,3 ;12  ;9600BPS FOR ARDUINO INTERFACE
     	CALL STOR_INI

LP1:    LD HL,MSG1
	CALL RS_TXT
	CALL GET_CHAR 
        CP 'M'
	JP Z,MENU
	CP 'A'
	CALL Z,APRESS
	CP 'O'
	CALL Z,OPENCRD
	CP 'D'
	CALL Z,DIRLIST
	CP 'C'
	CALL Z,DIRCHG
	CP 'F'
	CALL Z,OPENFILE
	CP '1'
	CALL Z,CTSLOW
	CP '2'
	CALL Z,CTSHI
	CP '0'
	CALL Z,TESTSEND
	CP '9'
	CALL Z,TESTRECV
	CP '8'
	CALL Z,TESTCTS	
        JR LP1

MSG1	DEFM "O:OPENCARD D:DIRLIST | M:MENU"
	DB 10,13,0

SENDCMD:CALL FLUSHREC
	LD B,4 
NXTBT:	LD A,(HL)
	CALL STOR_TX
	INC HL
	DJNZ NXTBT
	RET

OPENCRD:LD HL,CCRDOPN
	CALL SENDCMD
	CALL DEL2
	CALL STOR_RX   ;GET RESULT	
	RET

DIRLIST:LD HL,CDIRLST
	CALL SENDCMD
	CALL DEL2
	;WE RECEIVE THE DIR LIST UNTIL 255
	LD DE,BUFFER
NXTCHR	CALL STOR_RX 
	CP 255
	JR Z,DIROUT
	;PRINT TO LCD
	CALL LCD_PRINTCHAR
	JR NXTCHR
DIROUT:	CALL DEL2
	CALL STOR_RX   ;GET RESULT	
	RET


DIRCHG: LD HL,CDIRCHG
        CALL SENDCMD
	LD HL,DIRCRY
        CALL SENDFNAME		
	CALL DEL2
	CALL STOR_RX   ;GET RESULT	
	RET

;0 TERMINATED STRING
;ALSO SENDS A ZERO TO THE OTHER SIDE
SENDFNAME:	CALL STOR_TXT ;SEND FILENAME
		XOR A
		CALL STOR_TX
		RET

OPENFILE: 	LD HL,CFLEOPN  ;SEND OPEN COMMAND 
		CALL SENDCMD 
		LD HL,FILNAM
		CALL SENDFNAME
		CALL DEL2	
		CALL STOR_RX   ;GET RESULT	
		;RESULT IS FILE ID
		LD HL,FID
		LD (HL),A
		CP 200
		RET NC  ;ERROR OCCURED 
		LD HL,CBLCKRD
		INC HL
		LD (HL),A
		DEC HL	
		CALL SENDCMD  ;SEND BLOCKREAD COMMAND 0=ALL BYTES
		CALL DEL2
		CALL STOR_RX   ;GET BYTES TO BE SEND HI BYTE
		LD B,A		
		CALL STOR_RX   ;GET BYTES TO BE SEND LOW BYTE
		LD C,A
		LD A,B
		OR C
		JR Z,EREXIT   ;SOME ERROR OCCURED
 		;BC TOTAL BYTES TO RECEIVE
		LD A,13
		PUSH BC
		CALL LCD_PRINTCHAR
		POP BC
		
OFNXCH:		CALL STOR_RX
		PUSH BC
		CALL LCD_PRINTCHAR  ;PRINT TO SCREEN
		POP BC
		DEC BC
		LD A,B
		OR C
		JR NZ,OFNXCH
		JR OFEXIT
EREXIT:		LD HL,ERRMSG
		CALL LCD_MSG  ;PRINT TO SCREEN
OFEXIT:		CALL STOR_RX   ;GET RESULT		
		CALL RS_TX
		RET		
		
ERRMSG DEFB 13
       DEFM "ERROR ON RET BYTES"
       DEFB 13,0
		

CCRDOPN  DB 1,0,0,0
CFLEOPN  DB 2,0,0,0
CDIRLST  DB 10,0,0,0
CDIRCHG  DB 11,0,0,0
CBLCKRD  DB 6,0,0,0


DIRCRY	DEFM "Test"
	DB 0
FILNAM	DEFM "TEST.TXT"
	DB 0,0,0

BUFFER  DEFS 50
FID	DB 0


CTSLOW: LD A,2 ;BIT 1					;ready to receive SIGNAL RTS 1 MEANS ARDUINO CTS=0
       	OUT (MCR),A
	RET	

CTSHI:  XOR A
	OUT (MCR),A
	RET	

;'0'
TESTSEND: 	LD B,10
		LD HL,MES1
TSAGN:		LD A,(HL)
		CALL STOR_TX
		PUSH HL
		PUSH BC
		CALL LCD_PRINTCHAR
		POP BC
		POP HL
		INC HL
		DJNZ TSAGN
		RET
		

;'9'
TESTRECV:	LD A,13
		CALL LCD_PRINTCHAR
		LD A,'['
		CALL LCD_PRINTCHAR
		LD B,10
TRAGN:		CALL STOR_RX
		PUSH BC
		CALL LCD_PRINTCHAR
		POP BC
		DJNZ TRAGN
		LD A,']'
		CALL LCD_PRINTCHAR
		LD A,13
		CALL LCD_PRINTCHAR
		RET

TESTCTS:	IN A,(MSR)
		BIT 4,A		;COMPLEMENT OF CTS SO IF CTS=0 THIS IS 1
		JR NZ,TESTCTS
		RET


APRESS: CALL DEL2
	LD HL,MES1
	CALL STOR_TXT
	LD HL,MES2
	CALL STOR_TXT
	RET

MES1    DEFM "1234567890"
	DB 10,13,0

MES2    DEFM "ABCDEFGHIJKLMNOPQRSTUVWXYZ "
	DB 10,13,0


;THIS DELAYS 1MILISECOND ON 8MHZ CPU
DELAY:
DELAYMILISEC:	PUSH AF
	PUSH DE
	LD DE,300	;2000 1 MILISEC =300 ON 8MHZ SO 30= 0.1 MILISECS = 100 MICROSECS
DEL1:	DEC DE
	LD A,D            ;TEST FOR DE=00
	OR E
	JR NZ,DEL1 	
	POP DE
	POP AF
	RET

DEL2:LD B,80
DELAYMILI:	
S1:	CALL DELAYMILISEC
	DJNZ S1	
	RET


INCLUDE ATL_STORAGE.Z80