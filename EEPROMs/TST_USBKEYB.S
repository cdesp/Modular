ORG $9000

DEVEPR  EQU $08 ;Y1 EPROM WR SIGNAL ON/OFF 1/0 BIT 0
DEVKBD  EQU $08 ;Y1 USB KEYB ON/OFF ON/OFF 2/0 BIT 1
DEVINP  EQU $18 ;00;Y0 INPUT FROM DEVICES: DEV1=USB KEYB ON BITS 7=DATA & 6=CLOCK,DEV2=XXX
DEVKBI EQU DEVINP

WAITFORHIGH EQU $0CC0;
WAITFORLOW  EQU $0CDA;

            
;TEMP

JP AGN

INCLUDE MYOS_2.SYM
;---NEW USB KEYBOARD -------

;KEYCTR EQU $834E ;TEMP

;INCLUDE USBKEYB.S


CLKOFF: CALL KEYBCLKOFF
       LD B,20
       CALL DELAYSEC
      RET

CLKON: CALL KEYBCLKON
      LD B,20
      CALL DELAYSEC

	RET

EPROMOFF: LD B,0
       CALL FF_OFF
XOR A
       RET

EPROMON: LD B,0
      CALL FF_ON
XOR A
      RET

AGN:    LD HL,MS3
    CALL RS_TXT
 CALL GET_CHAR	;TAKE A CHAR FROM RS232 OR PS2 KEYB
CP 'M'
JP Z,MENU
CP 'T'
CALL Z,KEYB_TEST
CP 'R'
CALL Z,KB_TEST2
CP 'E'
CALL Z,KB_TEST3
CP 'Q'
CALL Z,TESTFFS
CP 'Y'
CALL Z,TESTKEYB
CP 'O'
CALL Z,CLKOFF
CP 'P'
CALL Z,CLKON
CP 'K'
CALL Z,EPROMOFF
CP 'L'
CALL Z,EPROMON
CP 'W'
CALL Z,MYTEST
JR AGN

MS3:DEFM "Q: FF CTRL, T,R,E,Y:TEST KEYBOARD"
    DB 10,13,0

MS9 DEFM "PRESS A KEY:"
    DB 0

MYTEST: LD HL,MS9
        CALL RS_TXT
        CALL TSTGET_CHAR
        CP 'Q'
        RET Z
	CALL RS_TX  
        LD A,10
        CALL RS_TX
        LD A,13     
        CALL RS_TX
        JR MYTEST

TSTGET_CHAR:	XOR A
	
	;GET CHAR FROM RS232
	CALL RS_KEYRD	;CHAR IN RS232?
	JR Z,GT_TST2
	CALL RS_RX	; GET THAT CHAR
	RET
	;GET CHAR FROM PS2 KEYBOARD
GT_TST2	
 ; JR GET_CHAR ; SHOULD BE REMOVED WHEN USB KEUB WORKS OK
  CALL PS2ISK  	;A=0 IF WE HAVE A KEY ELSE 1
	OR A
	JR NZ,TSTGET_CHAR	;RECHECK NO KEY
	CALL READCHAR	;GET THE KEY FROM USB KEYBOARD
        CP 0
        JR Z,TSTGET_CHAR
	RET





TESTKEYB: CALL CLKON
          LD B,10
TKAGN:    PUSH BC
          CALL READCHAR
          CP 0
          JR Z,ZERO
          CALL RS_TX
          JR NXT1
ZERO:     LD HL,MS4A
          CALL RS_TXT
NXT1:	  POP BC
          DJNZ TKAGN  
          RET   

MS4A DEFM "-ZERO"
     DEFB 10,13,0


MYDELAY: LD B,2
         CALL DELAYSEC
         RET


TESTFFS: LD B,0
         CALL FF_ON
         LD BC,$FFFF
         CALL MYDELAY
         LD B,1
         CALL FF_ON
         LD BC,$FFFF
         CALL MYDELAY

         LD B,0
         CALL FF_OFF
         LD BC,$FFFF
         CALL MYDELAY

         LD B,1
         CALL FF_OFF
         LD BC,$FFFF
         CALL MYDELAY
       


	RET
          

NEWBYTE1:LD C,0
    LD A,D ;BIT 7 HAS THE DATA
    BIT UKB_IN_DAT,A
    JR NZ,ERROR0 ;ALWAYS START WITH 0
    LD B,8
NXTBIT: CALL WAITFORHIGH 
    INC C
    RET C
    CALL WAITFORLOW
    INC C
    RET C
    SLA A ;BIT 7=DATA IS ON C FLAG
    RR E ;CARRY GOES TO BIT 0 OF E    
    DJNZ NXTBIT
    LD C,3
    CALL WAITFORHIGH 
    LD C,4
    RET C
    CALL WAITFORLOW     
    LD C,5
    RET C
    ;BIT 7 HAS THE PARITY
    CALL WAITFORHIGH 
    LD C,6
    RET C
    CALL WAITFORLOW 
    LD C,7
    RET C
    BIT UKB_IN_DAT,A
    JR Z,ERROR1 ;ALWAYS ENDS WITH 1 
    LD C,8 
    CALL WAITFORHIGH    ;WAIT FOR END OF TRANSMITION
    LD C,9
    RET C
    ;XOR A  ;NO ERROR RESET CARRY FLAG NOT NEEDED ALREAD CLEARED
    LD A,E
    RET
ERROR0: LD HL,MSER4
    CALL RS_TXT
    SCF ;FLAGS AN ERROR OCCURED
    RET
ERROR1:PUSH DE
    LD HL,MSER5
    CALL RS_TXT
    SCF ;FLAGS AN ERROR OCCURED
    POP DE
    LD A,E ;MAYBE IGNORE THIS
    RET
MSER4 DEFM "ERROR START BIT NOT AS EXPECTED."
    DB 10,13,0
MSER5 DEFM "ERROR STOP BIT NOT AS EXPECTED."
    DB 10,13,0  


MS1 DEFM "KEYBOARD TESTING. PRESS A KEY"
    DB 10,13,0

KEYB_TEST:;SHOULD BE ON AN INTERRUPT
    LD HL,MS1
    CALL RS_TXT
    LD HL,MS1
    CALL LCD_MSG
LP1:CALL KEYBCLKON ;KEYBOARD ENABLED
    IN A,(DEVKBI)
    LD D,A
    BIT 6,A ;CHECK BIT 6=CLOCK
    JR NZ,NOBYTE
    ;NEWBYTE ;START RECEIVING
    CALL NEWBYTE1
    PUSH AF
    LD A,C
    CALL SOUTAS 
    LD A,E
    CALL SOUTAS 
    CALL C,ERRCARRY
    POP AF
    ;ON A WE HAVE THE BYTE
    ;PRINT IT ON SERIAL
   ; PUSH AF
   ; LD HL,R2 
   ; CALL LCD_MSG
   ; POP AF
    CALL SOUTAS    
    JR KEYB_TEST
NOBYTE:;    CALL S2ON ;KEYBOARD DISABLED
    ;DO STAFF
    JR LP1
ERRCARRY:
     LD HL,MESCAR
     CALL RS_TXT
     RET

MESCAR: DEFM "ERROR,CARRY IS SET"
       DB 10,13,0
     


KB_TEST2: 
    LD HL,KBMES2 
    CALL LCD_MSG
    LD B,6
KNX1:PUSH BC
KNX2:    CALL PS2KEY
    CP 0
    JR Z,KNX2
    CALL SOUTAS
    POP BC
    DJNZ KNX1
    RET

KBMES1:DEFM "PRESS A KEY"
    DB 10,13,0
KBMES2:DEFM "PRESS 6 KEYS"
    DB 10,13,0


KB_TEST3:    LD HL,KBMES2
    CALL LCD_MSG
    LD B,6
KNX:PUSH BC
INVKEY:  CALL GTKEY ;0 IS AN INVALID KEY
    OR A
    JR Z,INVKEY
    CALL PS2LOK
    CALL RS_TX
    POP BC
    DJNZ KNX
    RET
    
MS2: DEFM "KEY PRESSED. RECEIVING"
    DB 10,13,0
MS5: DEFM "KEY RECEIVED OK"
    DB 10,13,0


