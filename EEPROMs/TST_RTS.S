ORG $9000

GET_CHAR EQU $031D
MENU	EQU $02A2

JP START

DEVSTOR EQU $30 ; SET ON MAIN



	RBR EQU DEVSTOR+0	;RECEIVER BUFFER REGISTER (READ ONLY) (DLAB = 0)
	THR EQU DEVSTOR+0	;TRANSMITER HOLDING REGISTER (WRITE ONLY) (DLAB = 0)
	IER EQU DEVSTOR+1	;INTERRUPT ENABLE REGISTER (DLAB = 0)
				;BIT 0= ENABLE RECEIVED DATA AVAILABLE INTERRUPT
				;BIT 1= ENABLE TRANSMITTER HOLDING REGISTER EMPTY INTERRUPT
				;BIT 2= ENABLE RECEIVER LINE STATUS INTERRUPT
				;BIT 3= ENABLE MODEM STATUS INTERRUPT
	IIR EQU DEVSTOR+2	;INTERRUPT IDENT. REGISTER (READ ONLY)
				;BIT 0=0 IF INTERRUPT PENDING
				;BIT 1-3 INTERRUPT ID
				;BIT 4,5 =0
				;BIT 6,7 FIFOS ENABLED					
	FCR EQU DEVSTOR+2	;FIFO CONTROL REGISTER (WRITE ONLY)
				;BIT 0 FIFO ENABLE
				;BIT 1 RCVR FIFO RESET
				;BIT 2 XMIT FIFO RESET
				;BIT 3 DMA MODE SELECT
				;BIT 4,5 RESERVED
				;BIT 6 RCVR TRIGGER LSBIT
				;BIT 7 RCVR TRIGGER MSBIT
	LCR EQU DEVSTOR+3	;LINE CONTROL REGISTER
				;BIT 0,1 WORD LENGTH SELECT
				;BIT 2 NUMBER OF STOP BITS
				;BIT 3 PARITY ENABLE
				;BIT 4 EVEN PARITY SELECT
				;BIT 5 STICK PARITY
				;BIT 6 SET BREAK
				;BIT 7 DIVISOR LATCH ACCESS BIT *** DLAB ****
	MCR EQU DEVSTOR+4	;MODEM CONTROL REGISTER 
	LSR EQU DEVSTOR+5	;LINE STATUS REGISTER
				;BIT 0 DATA READY
				;BIT 1 OVERRUN ERROR
				;BIT 2 PARITY ERROR
				;BIT 3 FRAMING ERROR
				;BIT 4 BREAK INTERRUPT
				;BIT 5 TRANSMITTER HOLDING REGISTER
				;BIT 6 TRANSMITTER EMPTY
				;BIT 7 ERROR IN RCVR FIFO
	MSR EQU DEVSTOR+6	;MODEM STATUS REGISTER
	SCR EQU DEVSTOR+7	;SCRATCH REGISTER
	DLL EQU DEVSTOR+0	;DIVISOR LATCH (LEAST SIGNIFICANT BYTE) (DLAB = 1)
	DLM EQU DEVSTOR+1	;DIVISOR LATCH (MOST SIGNIFICANT BYTE) (DLAB = 1)
	
				;A=5 RECEIVE INTERRUPTS ON
;A IS THE BAUD RATE PARAM				
STOR_INI:	PUSH AF
		LD      A,$80          	; Mask to set DLAB on
		OUT     (LCR),A         ; Send to LINe Control Register	
		;LD      A,12           ; Divisor of 12 = 9600 bps with 1.8432 MHz clock
		;LD      A,96           ; Divisor of 96 = 1200 bps with 1.8432 MHz clock
				; 72=1600BPS WITH 1.8432
		;LD A,6			;19200BPS
		;LD A,3			;38400BPS
		;LD A,2			;56000BPS
		;LD A,1			;115200BPS				
  		POP AF
		OUT     (DLL),A        	; Set LSB of divisor
		LD      A,00            ; This will be the MSB of the divisior
		OUT     (DLM),A        	; Send to the MSB register
		LD      A,$03          	; 8 bits, 1 stop, no parity (and clear DLAB)
		OUT     (LCR),A        	; Write new value to LCR
		;LD A, 1+2+4+8							; set fifo mode and reset fifio counters		//was 0 and commented 
  		LD A, 0							
  		OUT 	(FCR),A						;//was commented
		LD      A,$00          	; 5 A=0 Disable all INterrupts
		OUT     (IER),A        	; Send to INterrupt Enable Register	
		RET
		

START: CALL STOR_INI

MNU:	CALL GET_CHAR
	CP '1'
	CALL Z,DOON
	CP '2'
	CALL Z,DOOFF
	CP 'M'
	JP Z,MENU
	JP MNU


DOON: 	LD A,2 ;BIT 1			;ready to receive SIGNAL RTS 2
      	OUT (MCR),A
	RET



DOOFF:  XOR A
      	OUT (MCR),A
	RET