ORG $9000

JP START

INCLUDE MYOS_2_0000.SYM

INCLUDE ATL_PS2KEYB.Z80

START:  DI	
	CALL PS2ISK
        OR A
	JR NZ, START	
        CALL NEWBYTE							;D HAS THE LAST INPUT	
	JR C, PS2TIMEOUT1						;ERROR SO INVALIDATE A	
	CALL SOUTAS
        CALL KEYBCLKOFF
	EI
	JP MENU


PS2TIMEOUT1:	
	LD A,H
	CALL SOUTAS
	LD HL,MESTIM
	CALL RS_TXT
	EI
	JP MENU

MES 	DEFM "KEY PRESSED."
	DB 10,13,0

MESTIM 	DEFM "NB TIMEOUT."
	DB 10,13,0

SAMP EQU 250


PS2ISK2:	CALL KEYBCLKON 							;KEYBOARD ENABLED
		LD B, SAMP 							;CHECK SEVERAL TIMES 0.2 MS (30 ON 10mHZ)
CHAG2:		
		IN A, (DEVKBI)
		AND 64	;KEEP BIT 6
		LD D, A
		
		BIT 6, A						;CHECK BIT 6=CLOCK		
		NOP
		JR Z,KEYOK2
		JR NZ,DOITAGN
		PUSH BC
		PUSH DE
		CALL SOUTAS		
		POP DE
		POP BC
		LD A,D
		CP 0
		JR NZ,DOITAGN
		JR KEYOK2
DOITAGN:	DJNZ CHAG2
		LD HL,MESS2
		CALL RS_TXT

;JR PS2NTP
PS2NTP:		LD A, 1								;SET A TO 1 MEANS NO KEY AVAILABLE
		CALL KEYBCLKOFF
		RET
KEYOK2:		PUSH DE
		LD HL,MESS1
		CALL RS_TXT
		POP DE
		LD A,D
		CALL SOUTAS
		LD A,'<'
		CALL RS_TX
		XOR A		
		RET
		

MESS1 		DEFM "KEYOK2"
		DB 10,13,0
MESS2 		DEFM "TIMEOUT"
		DB 10,13,0


MERROR0:	CALL SOUTAS	
		LD HL, MSER4
		CALL RS_TXT
		SCF								;FLAGS AN ERROR OCCURED
		EI
		RET
MERROR1:		PUSH DE
		CALL SOUTAS
		LD HL, MSER5
		CALL RS_TXT
		SCF								;FLAGS AN ERROR OCCURED
		POP DE
		LD A, E								;MAYBE IGNORE THIS
		EI
		RET

MSER4:		DEFM "KB_ERR: START BIT."
		DB 10,13,0
MSER5:		DEFM "KB_ERR: STOP BIT."
		DB 10,13,0

NEWBYTE2:	DI
		LD A, D								;BIT 7 HAS THE DATA
		BIT UKB_IN_DAT, A
		JR NZ, MERROR0							;ALWAYS START WITH 0
		LD B, 8
		LD H,1
NXTBIT:		LD C, B								;SAVE B
		CALL WAITFORHIGH
		RET C
		INC H
		CALL WAITFORLOW
		RET C
		INC H
		SLA A								;BIT 7=DATA IS ON C FLAG
		RR E								;CARRY GOES TO BIT 7 OF E
		LD B, C 							;RESTORE B
		DJNZ NXTBIT
		INC H
		CALL WAITFORHIGH
		RET C
		INC H
		CALL WAITFORLOW
		RET C
		INC H
;BIT 7 HAS THE PARITY
		CALL WAITFORHIGH
		RET C
		INC H
		CALL WAITFORLOW
		RET C
		INC H
		BIT UKB_IN_DAT, A
		JR Z, MERROR1							;ALWAYS ENDS WITH 1
		INC H
		CALL WAITFORHIGH 						;WAIT FOR END OF TRANSMITION
		RET C
;XOR A  ;NO ERROR RESET CARRY FLAG NOT NEEDED ALREAD CLEARED
		LD A, E
		EI
		RET


